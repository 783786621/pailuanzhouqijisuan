import datetime
import calendar
import pandas as pd
import numpy as np
from typing import List, Tuple, Dict, Optional
import json
from dataclasses import dataclass
from enum import Enum

class Method(Enum):
    CALENDAR = "日历法"
    BBT = "基础体温法"
    CM = "宫颈黏液法"
    LH_TEST = "LH试纸法"
    B_MODE = "B超监测法"

@dataclass
class CycleData:
    """月经周期数据类"""
    start_date: datetime.date
    end_date: datetime.date
    length: int
    
@dataclass
class PredictionResult:
    """预测结果类"""
    ovulation_date: datetime.date
    fertile_window_start: datetime.date
    fertile_window_end: datetime.date
    next_period_date: datetime.date
    confidence: float  # 置信度 (0-1)
    methods_used: List[Method]

class MenstrualCycleCalculator:
    """科学排卵周期计算器"""
    
    def __init__(self, min_cycles_for_accuracy: int = 3):
        self.cycle_history: List[CycleData] = []
        self.min_cycles = min_cycles_for_accuracy
        self.bbt_data: Dict[datetime.date, float] = {}  # 基础体温数据
        self.lh_test_data: Dict[datetime.date, float] = {}  # LH试纸数据
        
    def add_cycle(self, start_date: datetime.date, end_date: datetime.date) -> None:
        """添加月经周期记录"""
        cycle_length = (end_date - start_date).days
        if cycle_length < 21 or cycle_length > 45:
            print(f"警告: 周期长度{cycle_length}天异常，正常范围21-45天")
        
        self.cycle_history.append(CycleData(start_date, end_date, cycle_length))
        
    def add_bbt_reading(self, date: datetime.date, temperature: float) -> None:
        """添加基础体温读数"""
        self.bbt_data[date] = temperature
        
    def add_lh_test_result(self, date: datetime.date, intensity: float) -> None:
        """添加LH试纸结果(强度0-1)"""
        self.lh_test_data[date] = intensity
    
    def calculate_cycle_stats(self) -> Dict[str, float]:
        """计算周期统计信息"""
        if len(self.cycle_history) < 2:
            return {}
            
        lengths = [c.length for c in self.cycle_history]
        
        stats = {
            "average_length": np.mean(lengths),
            "min_length": np.min(lengths),
            "max_length": np.max(lengths),
            "std_dev": np.std(lengths),
            "regularity": "规律" if np.std(lengths) <= 7 else "不规律"
        }
        
        return stats
    
    def predict_by_calendar(self, last_period_date: datetime.date) -> PredictionResult:
        """日历法预测"""
        if len(self.cycle_history) < self.min_cycles:
            print(f"警告: 至少需要{self.min_cycles}个周期记录以提高准确性")
            
        stats = self.calculate_cycle_stats()
        
        if not stats:
            # 默认使用28天周期
            avg_cycle = 28
            min_cycle = 26
            max_cycle = 30
        else:
            avg_cycle = int(stats["average_length"])
            min_cycle = int(stats["min_length"])
            max_cycle = int(stats["max_length"])
        
        # 计算下次月经日期
        next_period = last_period_date + datetime.timedelta(days=avg_cycle)
        
        # 排卵日 = 下次月经前14天
        ovulation_day = next_period - datetime.timedelta(days=14)
        
        # 受孕窗口期 = 排卵前5天至排卵后1天
        fertile_start = ovulation_day - datetime.timedelta(days=5)
        fertile_end = ovulation_day + datetime.timedelta(days=1)
        
        # 置信度计算
        if stats:
            regularity_factor = 1.0 if stats["regularity"] == "规律" else 0.6
            data_quality = min(len(self.cycle_history) / 6.0, 1.0)  # 最多6个周期
            confidence = 0.6 * regularity_factor * data_quality
        else:
            confidence = 0.3
        
        return PredictionResult(
            ovulation_date=ovulation_day,
            fertile_window_start=fertile_start,
            fertile_window_end=fertile_end,
            next_period_date=next_period,
            confidence=confidence,
            methods_used=[Method.CALENDAR]
        )
    
    def detect_ovulation_by_bbt(self) -> Optional[datetime.date]:
        """通过基础体温检测排卵"""
        if len(self.bbt_data) < 10:  # 至少10天数据
            return None
            
        # 将数据转换为DataFrame以便分析
        dates = sorted(self.bbt_data.keys())
        temps = [self.bbt_data[d] for d in dates]
        
        # 寻找体温上升点
        ovulation_date = None
        for i in range(1, len(temps)):
            if temps[i] - temps[i-1] >= 0.3:  # 体温上升0.3℃以上
                ovulation_date = dates[i-1]  # 排卵发生在体温上升前一天
                break
                
        return ovulation_date
    
    def detect_ovulation_by_lh_test(self) -> Optional[datetime.date]:
        """通过LH试纸检测排卵"""
        if not self.lh_test_data:
            return None
            
        # 寻找LH峰值（强度>0.8）
        peak_dates = [date for date, intensity in self.lh_test_data.items() if intensity >= 0.8]
        
        if not peak_dates:
            return None
            
        # 返回第一个峰值日期（排卵发生在峰值后24-48小时）
        return min(peak_dates)
    
    def comprehensive_prediction(self, last_period_date: datetime.date) -> PredictionResult:
        """综合预测（推荐方法）"""
        # 基础日历法预测
        calendar_pred = self.predict_by_calendar(last_period_date)
        
        methods_used = [Method.CALENDAR]
        confidence_boost = 0.0
        
        # 检查基础体温数据
        bbt_ovulation = self.detect_ovulation_by_bbt()
        if bbt_ovulation:
            methods_used.append(Method.BBT)
            # 验证日历法预测
            days_diff = abs((bbt_ovulation - calendar_pred.ovulation_date).days)
            if days_diff <= 2:
                confidence_boost += 0.2
            else:
                # 如果差异大，使用体温法结果调整
                calendar_pred.ovulation_date = bbt_ovulation
                calendar_pred.fertile_window_start = bbt_ovulation - datetime.timedelta(days=5)
                calendar_pred.fertile_window_end = bbt_ovulation + datetime.timedelta(days=1)
                confidence_boost += 0.15
        
        # 检查LH试纸数据
        lh_ovulation = self.detect_ovulation_by_lh_test()
        if lh_ovulation:
            methods_used.append(Method.LH_TEST)
            lh_ovulation_date = lh_ovulation + datetime.timedelta(days=1)  # LH峰值后24小时排卵
            
            days_diff = abs((lh_ovulation_date - calendar_pred.ovulation_date).days)
            if days_diff <= 1:
                confidence_boost += 0.25
            else:
                # 使用LH试纸结果
                calendar_pred.ovulation_date = lh_ovulation_date
                calendar_pred.fertile_window_start = lh_ovulation_date - datetime.timedelta(days=5)
                calendar_pred.fertile_window_end = lh_ovulation_date + datetime.timedelta(days=1)
                confidence_boost += 0.2
        
        # 更新置信度
        calendar_pred.confidence = min(calendar_pred.confidence + confidence_boost, 0.95)
        calendar_pred.methods_used = methods_used
        
        return calendar_pred
    
    def generate_calendar_view(self, start_date: datetime.date, months: int = 3) -> str:
        """生成日历视图"""
        calendar_view = []
        current_date = start_date
        
        for _ in range(months):
     
