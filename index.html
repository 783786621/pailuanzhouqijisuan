<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘å­¦æ’åµå‘¨æœŸè®¡ç®—å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
        }
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #eee;
        }
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        .tab.active {
            border-bottom: 3px solid #2E86AB;
            color: #2E86AB;
        }
        .tab:hover:not(.active) {
            background-color: #f9f9f9;
        }
        .tab-content {
            padding: 25px;
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #2E86AB;
            box-shadow: 0 0 0 2px rgba(46, 134, 171, 0.1);
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #2E86AB;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover {
            background: #236b8e;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-edit {
            background: #ffc107;
            color: #333;
        }
        .btn-edit:hover {
            background: #e0a800;
        }
        .btn-delete {
            background: #dc3545;
        }
        .btn-delete:hover {
            background: #c82333;
        }
        .result-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #2E86AB;
        }
        .result-item {
            margin-bottom: 12px;
            font-size: 16px;
        }
        .result-label {
            font-weight: 500;
            color: #2E86AB;
            margin-right: 8px;
        }
        .warning {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            font-weight: normal;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .stats-table th, .stats-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .stats-table th {
            background: #f5f7fa;
            color: #555;
            font-weight: 500;
        }
        .stats-summary {
            background: #e8f4f8;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .chart-container {
            width: 100%;
            height: 300px;
            margin: 20px 0;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #ddd;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .badge-ovulation {
            background: #ffc107;
            color: #333;
        }
        .badge-safe {
            background: #28a745;
            color: white;
        }
        .badge-period {
            background: #dc3545;
            color: white;
        }
        .badge-fertile {
            background: #dc3545;
            color: white;
        }
        /* ç¼–è¾‘æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            padding: 25px;
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }
        .modal-close:hover {
            color: #333;
        }
        .modal-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
        }
        .period-status {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        @media (max-width: 768px) {
            .tabs {
                flex-wrap: wrap;
            }
            .tab {
                flex: 1 1 50%;
            }
            .stats-table th, .stats-table td {
                padding: 8px;
                font-size: 14px;
            }
            .header h1 {
                font-size: 20px;
            }
            .tab-content {
                padding: 15px;
            }
            .btn {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ç§‘å­¦æ’åµå‘¨æœŸè®¡ç®—å™¨</h1>
            <p>è®°å½•æœˆç»å‘¨æœŸ Â· é¢„æµ‹æ’åµæ—¥æœŸ Â· å®‰å…¨éšç§æ— è”ç½‘</p>
        </div>

        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <div class="tab active" data-tab="record">è®°å½•æœˆç»</div>
            <div class="tab" data-tab="calculate">æ’åµè®¡ç®—</div>
            <div class="tab" data-tab="stats">å‘¨æœŸç»Ÿè®¡</div>
            <div class="tab" data-tab="chart">è¶‹åŠ¿å›¾è¡¨</div>
        </div>

        <!-- è®°å½•æœˆç»è¡¨å• -->
        <div class="tab-content active" id="record">
            <h3 style="margin-bottom: 20px; color: #333;">è®°å½•æ–°æœˆç»å‘¨æœŸ</h3>
            <div class="form-group">
                <label for="startDate">æœˆç»ç¬¬ä¸€å¤© <span style="color: #dc3545;">*</span></label>
                <input type="date" id="startDate" required>
            </div>
            <div class="form-group">
                <label for="endDateOption">æœˆç»ç»“æŸæ—¥æœŸè®¾ç½®</label>
                <select id="endDateOption">
                    <option value="auto">è‡ªåŠ¨è®¡ç®—ï¼ˆé»˜è®¤5å¤©ç»æœŸï¼‰</option>
                    <option value="manual">æ‰‹åŠ¨è¾“å…¥</option>
                </select>
            </div>
            <div class="form-group" id="endDateGroup" style="display: none;">
                <label for="endDate">æœˆç»æœ€åä¸€å¤© <span style="color: #dc3545;">*</span></label>
                <input type="date" id="endDate">
            </div>
            <div class="form-group" id="periodLengthGroup">
                <label for="periodLength">ç»æœŸé•¿åº¦ï¼ˆå¤©ï¼‰</label>
                <input type="number" id="periodLength" min="2" max="10" value="5">
                <p class="warning">é»˜è®¤5å¤©ï¼Œä¸€èˆ¬ç»æœŸä¸º2-10å¤©</p>
            </div>
            <button class="btn" id="saveCycleBtn">ä¿å­˜å‘¨æœŸè®°å½•</button>
            <div id="recordResult" class="result-card" style="display: none;"></div>
        </div>

        <!-- æ’åµè®¡ç®—ç»“æœ -->
        <div class="tab-content" id="calculate">
            <h3 style="margin-bottom: 20px; color: #333;">æ’åµå‘¨æœŸé¢„æµ‹ç»“æœ</h3>
            <div id="calculateEmpty" class="empty-state">
                <i>ğŸ“…</i>
                <p>æš‚æ— å‘¨æœŸæ•°æ®ï¼Œè¯·å…ˆè®°å½•æœˆç»</p>
            </div>
            <div id="calculateResult" style="display: none;">
                <div class="result-card">
                    <div class="result-item"><span class="result-label">å½“å‰å‘¨æœŸï¼š</span> <span id="calcCycleStart"></span></div>
                    <div class="result-item"><span class="result-label">å¹³å‡å‘¨æœŸé•¿åº¦ï¼š</span> <span id="calcAvgCycle"></span> å¤©</div>
                    <div class="result-item"><span class="result-label">æ’åµæ—¥é¢„æµ‹ï¼š</span> <span id="calcOvulationDay" class="badge badge-ovulation"></span></div>
                    <div class="result-item">
                        <span class="result-label">æ˜“å—å­•æœŸï¼ˆé«˜å—å­•ç‡ï¼‰ï¼š</span>
                        <div id="calcFertilePeriod" class="period-status"></div>
                    </div>
                    <div class="result-item">
                        <span class="result-label">å®‰å…¨æœŸï¼ˆå‚è€ƒï¼‰ï¼š</span>
                        <div id="calcSafePeriod" class="period-status"></div>
                    </div>
                    <div class="result-item"><span class="result-label">ä¸‹æ¬¡æœˆç»é¢„æµ‹ï¼š</span> <span id="calcNextPeriod"></span></div>
                    <div class="result-item warning">âš ï¸ æç¤ºï¼šå®‰å…¨æœŸä»…ä¸ºå‚è€ƒï¼Œéç»å¯¹é¿å­•ï¼›æ’åµå¯èƒ½å› æƒ…ç»ªã€å‹åŠ›ç­‰å› ç´ æ³¢åŠ¨Â±1-2å¤©</div>
                </div>
            </div>
        </div>

        <!-- å‘¨æœŸç»Ÿè®¡ -->
        <div class="tab-content" id="stats">
            <h3 style="margin-bottom: 20px; color: #333;">å‘¨æœŸç»Ÿè®¡æ±‡æ€»</h3>
            <div id="statsEmpty" class="empty-state">
                <i>ğŸ“Š</i>
                <p>æš‚æ— å‘¨æœŸæ•°æ®ï¼Œè¯·å…ˆè®°å½•æœˆç»</p>
            </div>
            <div id="statsContent" style="display: none;">
                <div class="stats-summary">
                    <div class="result-item"><span class="result-label">è®°å½•å‘¨æœŸæ•°ï¼š</span> <span id="statsCycleCount"></span> ä¸ª</div>
                    <div class="result-item"><span class="result-label">å¹³å‡å‘¨æœŸé•¿åº¦ï¼š</span> <span id="statsAvgCycle"></span> å¤©</div>
                    <div class="result-item"><span class="result-label">å¹³å‡ç»æœŸé•¿åº¦ï¼š</span> <span id="statsAvgPeriod"></span> å¤©</div>
                </div>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>æœˆç»å¼€å§‹</th>
                            <th>æœˆç»ç»“æŸ</th>
                            <th>ç»æœŸå¤©æ•°</th>
                            <th>å‘¨æœŸé•¿åº¦</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- è¶‹åŠ¿å›¾è¡¨ -->
        <div class="tab-content" id="chart">
            <h3 style="margin-bottom: 20px; color: #333;">å‘¨æœŸé•¿åº¦å˜åŒ–è¶‹åŠ¿</h3>
            <div id="chartEmpty" class="empty-state">
                <i>ğŸ“ˆ</i>
                <p>è‡³å°‘éœ€è¦2ä¸ªå®Œæ•´å‘¨æœŸæ‰èƒ½ç”Ÿæˆè¶‹åŠ¿å›¾</p>
            </div>
            <div id="chartContent" style="display: none;">
                <div class="chart-container">
                    <canvas id="cycleChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘å‘¨æœŸæ¨¡æ€æ¡† -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <span class="modal-close" id="modalClose">&times;</span>
            <h3 class="modal-title">ç¼–è¾‘å‘¨æœŸè®°å½•</h3>
            <input type="hidden" id="editCycleId">
            <div class="form-group">
                <label for="editStartDate">æœˆç»ç¬¬ä¸€å¤© <span style="color: #dc3545;">*</span></label>
                <input type="date" id="editStartDate" required>
            </div>
            <div class="form-group">
                <label for="editEndDateOption">æœˆç»ç»“æŸæ—¥æœŸè®¾ç½®</label>
                <select id="editEndDateOption">
                    <option value="auto">è‡ªåŠ¨è®¡ç®—ï¼ˆé»˜è®¤5å¤©ç»æœŸï¼‰</option>
                    <option value="manual">æ‰‹åŠ¨è¾“å…¥</option>
                </select>
            </div>
            <div class="form-group" id="editEndDateGroup" style="display: none;">
                <label for="editEndDate">æœˆç»æœ€åä¸€å¤© <span style="color: #dc3545;">*</span></label>
                <input type="date" id="editEndDate">
            </div>
            <div class="form-group" id="editPeriodLengthGroup">
                <label for="editPeriodLength">ç»æœŸé•¿åº¦ï¼ˆå¤©ï¼‰</label>
                <input type="number" id="editPeriodLength" min="2" max="10" value="5">
                <p class="warning">é»˜è®¤5å¤©ï¼Œä¸€èˆ¬ç»æœŸä¸º2-10å¤©</p>
            </div>
            <button class="btn" id="saveEditBtn">ä¿å­˜ä¿®æ”¹</button>
            <button class="btn btn-secondary" id="cancelEditBtn">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- å¼•å…¥Chart.jsç”¨äºå›¾è¡¨å±•ç¤ºï¼ˆCDNåŠ è½½ï¼Œæ— éœ€æœ¬åœ°å®‰è£…ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // æ•°æ®å­˜å‚¨æ ¸å¿ƒç±»
        class OvulationTracker {
            constructor() {
                this.key = 'ovulation_cycle_data';
                this.data = this.loadData();
            }

            // åŠ è½½æœ¬åœ°å­˜å‚¨æ•°æ®
            loadData() {
                const stored = localStorage.getItem(this.key);
                return stored ? JSON.parse(stored) : { cycles: [], average_cycle_length: 28 };
            }

            // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
            saveData() {
                localStorage.setItem(this.key, JSON.stringify(this.data));
            }

            // æ ¼å¼åŒ–æ—¥æœŸï¼ˆYYYY-MM-DD è½¬ å¹´æœˆæ—¥ï¼‰
            formatDate(dateStr) {
                const date = new Date(dateStr);
                return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
            }

            // æ ¼å¼åŒ–æ—¥æœŸä¸ºçŸ­æ ¼å¼ï¼ˆç”¨äºè¾“å…¥æ¡†ï¼‰
            formatDateShort(dateStr) {
                const date = new Date(dateStr);
                return date.toISOString().split('T')[0];
            }

            // è®¡ç®—æ—¥æœŸåŠ å‡
            addDays(dateStr, days) {
                const date = new Date(dateStr);
                date.setDate(date.getDate() + days);
                return date.toISOString().split('T')[0];
            }

            // è®¡ç®—ä¸¤ä¸ªæ—¥æœŸä¹‹é—´çš„å¤©æ•°
            getDaysBetween(startStr, endStr) {
                const start = new Date(startStr);
                const end = new Date(endStr);
                return Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
            }

            // æ·»åŠ æ–°å‘¨æœŸ
            addCycle(startDate, endDate) {
                const cycles = this.data.cycles;
                let cycleLength = null;

                // è®¡ç®—å‘¨æœŸé•¿åº¦ï¼ˆå¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ªå‘¨æœŸï¼‰
                if (cycles.length > 0) {
                    const lastStart = cycles[cycles.length - 1].start_date;
                    cycleLength = this.getDaysBetween(lastStart, startDate) - 1;
                }

                const newCycle = {
                    id: cycles.length + 1,
                    start_date: startDate,
                    end_date: endDate,
                    period_length: this.getDaysBetween(startDate, endDate),
                    cycle_length: cycleLength
                };

                cycles.push(newCycle);
                this.updateAverageCycleLength();
                this.saveData();
                return newCycle;
            }

            // æ›´æ–°å¹³å‡å‘¨æœŸé•¿åº¦
            updateAverageCycleLength() {
                const validCycles = this.data.cycles.filter(c => c.cycle_length !== null);
                if (validCycles.length > 0) {
                    const avg = Math.round(validCycles.reduce((sum, c) => sum + c.cycle_length, 0) / validCycles.length);
                    this.data.average_cycle_length = avg;
                }
            }

            // è®¡ç®—æ’åµç›¸å…³æ—¥æœŸï¼ˆåŸºäºæœ€æ–°å‘¨æœŸï¼‰
            calculateOvulation() {
                const cycles = this.data.cycles;
                if (cycles.length === 0) return null;

                const latestCycle = cycles[cycles.length - 1];
                const startDate = latestCycle.start_date;
                const avgCycle = this.data.average_cycle_length;

                // é¢„æµ‹ä¸‹æ¬¡æœˆç»
                const nextPeriod = this.addDays(startDate, avgCycle);
                // æ’åµæ—¥ï¼ˆä¸‹æ¬¡æœˆç»å‰14å¤©ï¼‰
                const ovulationDay = this.addDays(nextPeriod, -14);
                // æ’åµæœŸï¼ˆæ’åµæ—¥-4 ~ æ’åµæ—¥+1ï¼‰
                const ovulationStart = this.addDays(ovulationDay, -4);
                const ovulationEnd = this.addDays(ovulationDay, 1);
                // å®‰å…¨æœŸ
                const periodEnd = latestCycle.end_date;
                const safe1Start = this.addDays(periodEnd, 1);
                const safe1End = this.addDays(ovulationStart, -1);
                const safe2Start = this.addDays(ovulationEnd, 1);
                const safe2End = this.addDays(nextPeriod, -1);

                // å¤„ç†å®‰å…¨æœŸæ˜¾ç¤º
                const safePeriods = [];
                if (safe1Start <= safe1End) {
                    safePeriods.push({
                        text: `${this.formatDate(safe1Start)} ~ ${this.formatDate(safe1End)}`,
                        type: 'å‰å®‰å…¨æœŸ'
                    });
                }
                if (safe2Start <= safe2End) {
                    safePeriods.push({
                        text: `${this.formatDate(safe2Start)} ~ ${this.formatDate(safe2End)}`,
                        type: 'åå®‰å…¨æœŸ'
                    });
                }

                return {
                    cycle_start: this.formatDate(startDate),
                    average_cycle_length: avgCycle,
                    ovulation_day: this.formatDate(ovulationDay),
                    ovulation_period: {
                        start: this.formatDate(ovulationStart),
                        end: this.formatDate(ovulationEnd),
                        text: `${this.formatDate(ovulationStart)} ~ ${this.formatDate(ovulationEnd)}`
                    },
                    safe_periods: safePeriods,
                    next_period_prediction: this.formatDate(nextPeriod)
                };
            }

            // è·å–ç»Ÿè®¡æ•°æ®
            getStats() {
                const cycles = this.data.cycles;
                if (cycles.length === 0) return null;

                const avgCycle = this.data.average_cycle_length;
                const avgPeriod = Math.round(cycles.reduce((sum, c) => sum + c.period_length, 0) / cycles.length);

                return {
                    cycle_count: cycles.length,
                    avg_cycle: avgCycle,
                    avg_period: avgPeriod,
                    cycles: cycles.map(c => ({
                        id: c.id,
                        start_date: this.formatDate(c.start_date),
                        end_date: this.formatDate(c.end_date),
                        start_date_short: this.formatDateShort(c.start_date),
                        end_date_short: this.formatDateShort(c.end_date),
                        period_length: c.period_length,
                        cycle_length: c.cycle_length || 'â€”'
                    }))
                };
            }

            // è·å–å›¾è¡¨æ•°æ®
            getChartData() {
                const validCycles = this.data.cycles.filter(c => c.cycle_length !== null);
                if (validCycles.length < 2) return null;

                return {
                    labels: validCycles.map(c => `å‘¨æœŸ${c.id}`),
                    data: validCycles.map(c => c.cycle_length),
                    avg: this.data.average_cycle_length
                };
            }

            // æ ¹æ®IDè·å–å‘¨æœŸ
            getCycleById(cycleId) {
                return this.data.cycles.find(c => c.id === cycleId) || null;
            }

            // æ›´æ–°å‘¨æœŸ
            updateCycle(cycleId, newStartDate, newEndDate) {
                const cycleIndex = this.data.cycles.findIndex(c => c.id === cycleId);
                if (cycleIndex === -1) return null;

                const oldCycle = this.data.cycles[cycleIndex];
                const newPeriodLength = this.getDaysBetween(newStartDate, newEndDate);

                // æ›´æ–°å½“å‰å‘¨æœŸ
                const updatedCycle = {
                    ...oldCycle,
                    start_date: newStartDate,
                    end_date: newEndDate,
                    period_length: newPeriodLength
                };

                this.data.cycles[cycleIndex] = updatedCycle;

                // æ›´æ–°åç»­å‘¨æœŸçš„å‘¨æœŸé•¿åº¦
                this.updateSubsequentCycleLengths(cycleIndex);

                // æ›´æ–°å¹³å‡å‘¨æœŸé•¿åº¦
                this.updateAverageCycleLength();
                this.saveData();

                return updatedCycle;
            }

            // æ›´æ–°åç»­å‘¨æœŸçš„å‘¨æœŸé•¿åº¦
            updateSubsequentCycleLengths(startIndex) {
                const cycles = this.data.cycles;
                for (let i = startIndex + 1; i < cycles.length; i++) {
                    const prevStart = cycles[i - 1].start_date;
                    const currentStart = cycles[i].start_date;
                    cycles[i].cycle_length = this.getDaysBetween(prevStart, currentStart) - 1;
                }
            }

            // åˆ é™¤å‘¨æœŸ
            deleteCycle(cycleId) {
                const cycleIndex = this.data.cycles.findIndex(c => c.id === cycleId);
                if (cycleIndex === -1) return false;

                // åˆ é™¤å‘¨æœŸ
                this.data.cycles.splice(cycleIndex, 1);

                // é‡æ–°ç¼–å·
                this.data.cycles.forEach((cycle, index) => {
                    cycle.id = index + 1;
                });

                // æ›´æ–°åç»­å‘¨æœŸçš„å‘¨æœŸé•¿åº¦
                this.updateSubsequentCycleLengths(Math.max(0, cycleIndex - 1));

                // æ›´æ–°å¹³å‡å‘¨æœŸé•¿åº¦
                this.updateAverageCycleLength();
                this.saveData();

                return true;
            }
        }

        // åˆå§‹åŒ– tracker
        const tracker = new OvulationTracker();

        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // åˆ‡æ¢æ ‡ç­¾æ¿€æ´»çŠ¶æ€
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
                const tabId = tab.getAttribute('data-tab');
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabId).classList.add('active');

                // åˆ‡æ¢åˆ°å¯¹åº”æ ‡ç­¾æ—¶æ›´æ–°æ•°æ®
                if (tabId === 'calculate') updateCalculateTab();
                if (tabId === 'stats') updateStatsTab();
                if (tabId === 'chart') updateChartTab();
            });
        });

        // ç»“æŸæ—¥æœŸé€‰é¡¹åˆ‡æ¢ï¼ˆæ–°å¢è¡¨å•ï¼‰
        document.getElementById('endDateOption').addEventListener('change', (e) => {
            const endDateGroup = document.getElementById('endDateGroup');
            const periodLengthGroup = document.getElementById('periodLengthGroup');
            
            if (e.target.value === 'manual') {
                endDateGroup.style.display = 'block';
                periodLengthGroup.style.display = 'none';
            } else {
                endDateGroup.style.display = 'none';
                periodLengthGroup.style.display = 'block';
            }
        });

        // ç»“æŸæ—¥æœŸé€‰é¡¹åˆ‡æ¢ï¼ˆç¼–è¾‘è¡¨å•ï¼‰
        document.getElementById('editEndDateOption').addEventListener('change', (e) => {
            const endDateGroup = document.getElementById('editEndDateGroup');
            const periodLengthGroup = document.getElementById('editPeriodLengthGroup');
            
            if (e.target.value === 'manual') {
                endDateGroup.style.display = 'block';
                periodLengthGroup.style.display = 'none';
            } else {
                endDateGroup.style.display = 'none';
                periodLengthGroup.style.display = 'block';
            }
        });

        // ä¿å­˜å‘¨æœŸè®°å½•
        document.getElementById('saveCycleBtn').addEventListener('click', () => {
            const startDate = document.getElementById('startDate').value;
            const endDateOption = document.getElementById('endDateOption').value;
            let endDate = '';

            if (!startDate) {
                alert('è¯·é€‰æ‹©æœˆç»ç¬¬ä¸€å¤©ï¼');
                return;
            }

            // è®¡ç®—ç»“æŸæ—¥æœŸ
            if (endDateOption === 'manual') {
                endDate = document.getElementById('endDate').value;
                if (!endDate) {
                    alert('è¯·é€‰æ‹©æœˆç»æœ€åä¸€å¤©ï¼');
                    return;
                }
                if (new Date(endDate) < new Date(startDate)) {
                    alert('ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸï¼');
                    return;
                }
            } else {
                const periodLength = parseInt(document.getElementById('periodLength').value);
                endDate = tracker.addDays(startDate, periodLength - 1);
            }

            // æ·»åŠ å‘¨æœŸ
            const newCycle = tracker.addCycle(startDate, endDate);
            const resultEl = document.getElementById('recordResult');
            
            // æ˜¾ç¤ºç»“æœ
            resultEl.style.display = 'block';
            resultEl.innerHTML = `
                <div class="result-item">âœ… æœˆç»å‘¨æœŸè®°å½•æˆåŠŸï¼</div>
                <div class="result-item"><span class="result-label">å‘¨æœŸIDï¼š</span> ${newCycle.id}</div>
                <div class="result-item"><span class="result-label">æœˆç»æ—¶é—´ï¼š</span> ${tracker.formatDate(newCycle.start_date)} ~ ${tracker.formatDate(newCycle.end_date)}ï¼ˆå…±${newCycle.period_length}å¤©ï¼‰</div>
                ${newCycle.cycle_length ? `<div class="result-item"><span class="result-label">æœ¬æ¬¡å‘¨æœŸé•¿åº¦ï¼š</span> ${newCycle.cycle_length}å¤©</div>` : ''}
            `;

            // é‡ç½®è¡¨å•
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('endDateOption').value = 'auto';
            document.getElementById('periodLength').value = 5;
            document.getElementById('endDateGroup').style.display = 'none';
            document.getElementById('periodLengthGroup').style.display = 'block';

            // æ›´æ–°å…¶ä»–æ ‡ç­¾é¡µæ•°æ®
            updateCalculateTab();
            updateStatsTab();
            updateChartTab();
        });

        // æ›´æ–°æ’åµè®¡ç®—æ ‡ç­¾é¡µï¼ˆä¼˜åŒ–æ˜“å—å­•æœŸ/å®‰å…¨æœŸæ˜¾ç¤ºï¼‰
        function updateCalculateTab() {
            const result = tracker.calculateOvulation();
            const emptyEl = document.getElementById('calculateEmpty');
            const resultEl = document.getElementById('calculateResult');

            if (!result) {
                emptyEl.style.display = 'block';
                resultEl.style.display = 'none';
            } else {
                emptyEl.style.display = 'none';
                resultEl.style.display = 'block';
                
                document.getElementById('calcCycleStart').textContent = result.cycle_start;
                document.getElementById('calcAvgCycle').textContent = result.average_cycle_length;
                document.getElementById('calcOvulationDay').textContent = result.ovulation_day;
                document.getElementById('calcNextPeriod').textContent = result.next_period_prediction;

                // æ¸²æŸ“æ˜“å—å­•æœŸ
                const fertilePeriodEl = document.getElementById('calcFertilePeriod');
                fertilePeriodEl.innerHTML = '';
                const fertileBadge = document.createElement('span');
                fertileBadge.className = 'badge badge-fertile';
                fertileBadge.textContent = `${result.ovulation_period.start} ~ ${result.ovulation_period.end}`;
                fertilePeriodEl.appendChild(fertileBadge);

                // æ¸²æŸ“å®‰å…¨æœŸ
                const safePeriodEl = document.getElementById('calcSafePeriod');
                safePeriodEl.innerHTML = '';
                if (result.safe_periods.length > 0) {
                    result.safe_periods.forEach(period => {
                        const safeBadge = document.createElement('span');
                        safeBadge.className = 'badge badge-safe';
                        safeBadge.textContent = `${period.type}ï¼š${period.text}`;
                        safePeriodEl.appendChild(safeBadge);
                    });
                } else {
                    const noSafeBadge = document.createElement('span');
                    noSafeBadge.className = 'badge';
                    noSafeBadge.style.backgroundColor = '#ccc';
                    noSafeBadge.style.color = '#333';
                    noSafeBadge.textContent = 'æ— å®‰å…¨æœŸï¼ˆå‘¨æœŸè¿‡çŸ­ï¼‰';
                    safePeriodEl.appendChild(noSafeBadge);
                }
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ ‡ç­¾é¡µï¼ˆæ–°å¢ç¼–è¾‘/åˆ é™¤åŠŸèƒ½ï¼‰
        function updateStatsTab() {
            const stats = tracker.getStats();
            const emptyEl = document.getElementById('statsEmpty');
            const contentEl = document.getElementById('statsContent');

            if (!stats) {
                emptyEl.style.display = 'block';
                contentEl.style.display = 'none';
            } else {
                emptyEl.style.display = 'none';
                contentEl.style.display = 'block';
                
                document.getElementById('statsCycleCount').textContent = stats.cycle_count;
                document.getElementById('statsAvgCycle').textContent = stats.avg_cycle;
                document.getElementById('statsAvgPeriod').textContent = stats.avg_period;

                // å¡«å……è¡¨æ ¼
                const tableBody = document.getElementById('statsTableBody');
                tableBody.innerHTML = '';
                stats.cycles.forEach(cycle => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${cycle.id}</td>
                        <td>${cycle.start_date}</td>
                        <td>${cycle.end_date}</td>
                        <td>${cycle.period_length}</td>
                        <td>${cycle.cycle_length}</td>
                        <td>
                            <button class="btn btn-edit" data-id="${cycle.id}">ç¼–è¾‘</button>
                            <button class="btn btn-delete" data-id="${cycle.id}">åˆ é™¤</button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });

                // ç»‘å®šç¼–è¾‘æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const cycleId = parseInt(e.target.getAttribute('data-id'));
                        openEditModal(cycleId);
                    });
                });

                // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const cycleId = parseInt(e.target.getAttribute('data-id'));
                        if (confirm(`ç¡®å®šè¦åˆ é™¤å‘¨æœŸID ${cycleId} çš„è®°å½•å—ï¼Ÿ`)) {
                            const success = tracker.deleteCycle(cycleId);
                            if (success) {
                                alert('åˆ é™¤æˆåŠŸï¼');
                                updateStatsTab();
                                updateCalculateTab();
                                updateChartTab();
                            } else {
                                alert('åˆ é™¤å¤±è´¥ï¼Œæœªæ‰¾åˆ°è¯¥å‘¨æœŸï¼');
                            }
                        }
                    });
                });
            }
        }

        // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
        function openEditModal(cycleId) {
            const cycle = tracker.getCycleById(cycleId);
            if (!cycle) {
                alert('æœªæ‰¾åˆ°è¯¥å‘¨æœŸè®°å½•ï¼');
                return;
            }

            // å¡«å……è¡¨å•æ•°æ®
            document.getElementById('editCycleId').value = cycle.id;
            document.getElementById('editStartDate').value = tracker.formatDateShort(cycle.start_date);
            document.getElementById('editEndDate').value = tracker.formatDateShort(cycle.end_date);
            document.getElementById('editPeriodLength').value = cycle.period_length;

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('editModal').style.display = 'flex';
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        document.getElementById('modalClose').addEventListener('click', () => {
            document.getElementById('editModal').style.display = 'none';
        });

        document.getElementById('cancelEditBtn').addEventListener('click', () => {
            document.getElementById('editModal').style.display = 'none';
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.addEventListener('click', (e) => {
            if (e.target === document.getElementById('editModal')) {
                document.getElementById('editModal').style.display = 'none';
            }
        });

        // ä¿å­˜ç¼–è¾‘
        document.getElementById('saveEditBtn').addEventListener('click', () => {
            const cycleId = parseInt(document.getElementById('editCycleId').value);
            const startDate = document.getElementById('editStartDate').value;
            const endDateOption = document.getElementById('editEndDateOption').value;
            let endDate = '';

            if (!startDate) {
                alert('è¯·é€‰æ‹©æœˆç»ç¬¬ä¸€å¤©ï¼');
                return;
            }

            // è®¡ç®—ç»“æŸæ—¥æœŸ
            if (endDateOption === 'manual') {
                endDate = document.getElementById('editEndDate').value;
                if (!endDate) {
                    alert('è¯·é€‰æ‹©æœˆç»æœ€åä¸€å¤©ï¼');
                    return;
                }
                if (new Date(endDate) < new Date(startDate)) {
                    alert('ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸï¼');
                    return;
                }
            } else {
                const periodLength = parseInt(document.getElementById('editPeriodLength').value);
                endDate = tracker.addDays(startDate, periodLength - 1);
            }

            // æ›´æ–°å‘¨æœŸ
            const updatedCycle = tracker.updateCycle(cycleId, startDate, endDate);
            if (updatedCycle) {
                alert('ä¿®æ”¹æˆåŠŸï¼');
                document.getElementById('editModal').style.display = 'none';
                updateStatsTab();
                updateCalculateTab();
                updateChartTab();
            } else {
                alert('ä¿®æ”¹å¤±è´¥ï¼Œæœªæ‰¾åˆ°è¯¥å‘¨æœŸï¼');
            }
        });

        // æ›´æ–°å›¾è¡¨æ ‡ç­¾é¡µ
        function updateChartTab() {
            const chartData = tracker.getChartData();
            const emptyEl = document.getElementById('chartEmpty');
            const contentEl = document.getElementById('chartContent');

            if (!chartData) {
                emptyEl.style.display = 'block';
                contentEl.style.display = 'none';
                return;
            }

            emptyEl.style.display = 'none';
            contentEl.style.display = 'block';

            // åˆå§‹åŒ–å›¾è¡¨
            const ctx = document.getElementById('cycleChart').getContext('2d');
            
            // å¦‚æœå·²æœ‰å›¾è¡¨å®ä¾‹ï¼Œå…ˆé”€æ¯
            if (window.cycleChartInstance) {
                window.cycleChartInstance.destroy();
            }

            // åˆ›å»ºæ–°å›¾è¡¨
            window.cycleChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'å®é™…å‘¨æœŸé•¿åº¦ï¼ˆå¤©ï¼‰',
                            data: chartData.data,
                            borderColor: '#2E86AB',
                            backgroundColor: 'rgba(46, 134, 171, 0.1)',
                            borderWidth: 2,
                            pointBackgroundColor: '#2E86AB',
                            pointRadius: 4,
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: `å¹³å‡å‘¨æœŸé•¿åº¦ï¼ˆ${chartData.avg}å¤©ï¼‰`,
                            data: chartData.labels.map(() => chartData.avg),
                            borderColor: '#E63946',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: Math.min(...chartData.data) - 2,
                            max: Math.max(...chartData.data) + 2,
                            title: {
                                display: true,
                                text: 'å‘¨æœŸé•¿åº¦ï¼ˆå¤©ï¼‰'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'å‘¨æœŸ'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        }

        // åˆå§‹åŒ–é¡µé¢æ—¶è®¾ç½®é»˜è®¤æ—¥æœŸï¼ˆä»Šå¤©ï¼‰
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;

            // åˆå§‹åŒ–å„æ ‡ç­¾é¡µæ•°æ®
            updateCalculateTab();
            updateStatsTab();
            updateChartTab();
        });
    </script>
</body>
</html>
